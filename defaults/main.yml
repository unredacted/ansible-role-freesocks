# defaults/main.yml - Default variables for the role

# Operation mode: 'deploy', 'migrate', 'change', or 'update'
# - deploy: Install server with selected components (outline, slipstream, etc.)
# - migrate: Migrate server and its components from source to destination host
# - change: Rotate hostname on existing server (for DNS blocking bypass)
# - update: Add components (slipstream, WSS) to an existing server
# operation_mode: deploy

# ============================================================================
# Component Selection (Deploy Mode)
# ============================================================================
# Deploy mode installs combinations of components based on these flags:
#
# Outline (Shadowsocks proxy):
outline_enabled: true  # Default: deploy Outline SS server

# slipstream DNS tunnel (see slipstream section below):
# slipstream_enabled: false  # Disabled by default, enable in playbook
# slipstream_mode: "shadowsocks"  # or "raw" for standalone SOCKS5 proxy
#
# Example deployment combinations:
#   1. Outline only: outline_enabled=true, slipstream_enabled=false (default)
#   2. Outline + slipstream: outline_enabled=true, slipstream_enabled=true, slipstream_mode=shadowsocks
#   3. slipstream only (raw): outline_enabled=false, slipstream_enabled=true, slipstream_mode=raw
#   4. Both transports: outline_enabled=true, slipstream_enabled=true, slipstream_mode=raw
#      (slipstream provides standalone proxy, Outline provides SS)

# ============================================================================
# Force Reinstall Options (Update and Deploy modes)
# ============================================================================
# Force reinstall of components even if already detected as installed.
# Useful for:
#   - Recovery from partial installations (e.g., slipstream installed but KV not updated)
#   - Updating component configuration after changes
#   - Regenerating certificates/configs
#
# Usage: --extra-vars "force_reinstall_slipstream=true"
force_reinstall_slipstream: false
# Force rebuild of slipstream-server binary from source (even if already installed)
# Useful for updating to a new version with bug fixes (e.g., increased max connections)
# Usage: --extra-vars "force_rebuild_slipstream=true"
force_rebuild_slipstream: false
force_reinstall_wss: false

# Migration settings
# Whether to delete source server KV entries after successful migration
migrate_delete_source: false

# Change mode settings
# REQUIRED for change mode:
#   change_target_domain: The domain to generate a new hostname for (must exist in domain_providers)
#
# Deploy mode settings
# REQUIRED for deploy mode:
#   deploy_target_domain: The domain to deploy the new server to (must exist in domain_providers)
#
# Domain-to-Provider Mapping (required for change mode)
# Maps each domain to its DNS and tunnel provider configuration
# This enables hostname rotation across domains with different providers
#
# Example:
# domain_providers:
#   example.com:
#     dns_provider: cloudflare
#     tunnel_provider: cloudflare
#     zone_id: "your-cloudflare-zone-id"
#   example.app:
#     dns_provider: cloudflare
#     tunnel_provider: cloudflare
#     zone_id: "another-zone-id"
#   # Future: other providers
#   # example.org:
#   #   dns_provider: fastly
#   #   tunnel_provider: none
domain_providers: {}

# Whether to delete old DNS records after hostname change
change_delete_old_dns: true
# Whether to delete old KV entries after hostname change
change_delete_old_kv: true

# DNS Proxy Settings
# Enable CDN proxy for DNS records (Cloudflare orange cloud, Fastly shield, etc.)
# When true, traffic is proxied through the CDN; when false, DNS-only mode
dns_proxied: false

# Common settings
# OS version for cloudflared installation (e.g., "bookworm", "jammy")
cloudflared_os_version: "{{ ansible_distribution_release }}"

# Custom hostname override (optional)
# If set, this hostname will be used instead of generating a random 3-word hostname
# Can be used in deploy mode and change mode
# Example: custom_hostname: "my-custom-server"
# custom_hostname:

# Number of words in randomly generated hostnames (default: 3)
# Examples: 2 = "apple-banana", 3 = "apple-banana-cherry", 4 = "apple-banana-cherry-dog"
hostname_word_count: 3

# Outline server ports
outline_api_port: 8443
outline_keys_port: 443

# WebSocket (WSS) Support Configuration
# Enable SS over WSS for improved censorship resistance
# When enabled, Caddy will handle HTTPS on port 443 and proxy WebSocket traffic
outline_wss_enabled: false

# Caddy Web Server Configuration (used when outline_wss_enabled is true)
# Auto HTTPS uses ACME to obtain certificates automatically
outline_caddy_auto_https: true
outline_caddy_email: ""        # Required for auto HTTPS (ACME registration)
outline_caddy_domain: ""       # Defaults to dns_hostname if not set

# WebSocket Listener Paths
# Random paths are enabled by default for improved censorship resistance
# Uses dictionary words (like hostnames) for natural-looking URLs
outline_wss_random_paths: true
outline_wss_random_path_min_words: 3  # Minimum number of words in path
outline_wss_random_path_max_words: 5  # Maximum number of words (random in range)

# Custom paths (used when outline_wss_random_paths is false)
outline_wss_tcp_path: "/tcp"
outline_wss_udp_path: "/udp"
outline_wss_server_port: 8080  # Internal WebSocket server port (proxied by Caddy)

# API Proxy Configuration
# When set, Caddy will reverse proxy the management API with valid TLS certificates
# This enables access from platforms that reject self-signed certs (e.g., Cloudflare Workers)
outline_api_proxy_path: "/api"  # Path prefix for API (e.g., "/api" -> https://domain/api/...)

# API and Prometheus Hostname Suffixes
# When using Caddy proxy, these can be empty (everything goes through port 443)
# Set to "-api" or "-prom" for separate subdomains (legacy behavior)
api_hostname_suffix: ""   # e.g., "" for same domain, "-api" for api subdomain
prom_hostname_suffix: ""  # e.g., "" for same domain, "-prom" for prom subdomain

# Custom Docker image for Shadowbox (optional)
# If set, this image will be used instead of the default
# Example: custom_docker_image_shadowbox: "ghcr.io/unredacted/outline/shadowbox:latest"
# custom_docker_image_shadowbox:

# Optional hostname extension appended to server names
hostname_extension: ""

# Envoy server mappings
# Maps hostnames to their IPv4 and IPv6 addresses
# Example structure:
# envoy_mappings:
#   outline1-jfk:  # Outline server hostname
#     ipv4:
#       - 1.2.3.4
#       - 5.6.7.8
#     ipv6:
#       - 2001:db8::1
#       - 2001:db8::2
#   outline2-rmo:
#     ipv4:
#       - 9.10.11.12
#     ipv6:
#       - 2001:db8::3

# Environment mode: 'prod' or 'dev'
# - prod: Uses production KV namespaces for live deployments
# - dev: Uses development KV namespaces for testing
# This must be explicitly set via --extra-vars to prevent accidental deployments
# environment_mode: prod

# Provider Configuration
# These must be explicitly set via --extra-vars

# dns_provider: 'cloudflare'
#   - cloudflare: Manage DNS via Cloudflare API
#   Future: fastly, route53, etc.

# tunnel_provider: 'cloudflare' or 'none'
#   - cloudflare: Set up Cloudflare Tunnel for API/Prometheus access
#   - none: Skip tunnel setup (direct access to API/Prometheus ports)

# kv_provider: 'cloudflare'
#   - cloudflare: Store server endpoints in Cloudflare KV
#   Future: fastly, redis, etc.

# Required variables that must be set by the user:
# cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"
# cloudflare_api_token: "your-api-token"  # API Token (not Global API Key)
# cloudflare_zone_id: "your-zone-id"
# cloudflare_account_id: "your-account-id"
# base_domain: "example.com"
# api_domain: "api.example.com"
# prom_domain: "prom.example.com"
# cloudflare_access_team_name: "your-team-name"
# cloudflare_access_aud_tag: "your-aud-tag"
# kv_hostname_prefix: "outline"

# Zone IDs are looked up from domain_providers based on base_domain, api_domain, and prom_domain
# No need to set zone_id separately - it's derived from domain_providers[domain].zone_id

envoy_mappings: {}  # Define your envoy mappings as shown in the example above

# KV Namespace Configuration
# Production KV namespaces (used when environment_mode is 'prod')
# cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
# cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"

# Development KV namespaces (used when environment_mode is 'dev')
# cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
# cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"

# Additional required variables for migration mode:
# source_hostname: "outline1-jfk"      # Hostname of the source server
# destination_hostname: "outline2-rmo"  # Hostname of the destination server

# ============================================================================
# slipstream DNS Tunnel Configuration
# ============================================================================
# Enable slipstream-rust DNS tunnel for extreme censorship resistance
# Traffic is tunneled through DNS queries via recursive resolvers
slipstream_enabled: false

# slipstream mode:
#   - "shadowsocks": Tunnel to local Shadowsocks server (default)
#                    - slipstream → outline-ss-server:443
#                    - Client needs: slipstream-client + ss-local
#   - "raw": Direct TCP tunnel via SOCKS5 proxy
#            - slipstream → microsocks (SOCKS5) → internet
#            - Client only needs: slipstream-client (as SOCKS proxy)
slipstream_mode: "shadowsocks"

# Note: slipstream_domain is auto-generated from slipstream_base_domain + slipstream_subdomain
# e.g., slipstream_subdomain=dns1, slipstream_base_domain=your-dns.com → dns1.your-dns.com

# DNS resolvers for clients
# These should be public recursive resolvers accessible from censored regions
# Common options:
#   - Yandex DNS (Russia allowlist): 77.88.8.8:53, 77.88.8.1:53
#   - Google DNS: 8.8.8.8:53, 8.8.4.4:53
#   - Cloudflare DNS: 1.1.1.1:53, 1.0.0.1:53
#   - Local ISP resolvers (check if they forward recursively)
slipstream_resolver: "77.88.8.8:53"
slipstream_resolver_backup: "77.88.8.1:53"

# slipstream version/branch to build from
slipstream_version: "main"
slipstream_repo_url: "https://github.com/unredacted/slipstream-rust.git"

# DNS port for slipstream server (default: 53)
slipstream_dns_port: 53

# Log level for slipstream server (debug, info, warn, error)
slipstream_log_level: "info"

# Raw mode SOCKS5 proxy configuration
# When slipstream_mode is "raw", microsocks is installed and slipstream forwards to it
slipstream_socks_port: 1080  # Local SOCKS5 port (microsocks)

# ============================================================================
# slipstream DNS Record Configuration (REQUIRED when slipstream_enabled=true)
# ============================================================================
# These variables MUST be set via --extra-vars when enabling slipstream.
# No defaults are provided to force explicit configuration for each server.
#
# Example usage:
#   ansible-playbook playbook.yml \
#     --extra-vars "slipstream_enabled=true" \
#     --extra-vars "slipstream_base_domain=your-dns.com" \
#     --extra-vars "slipstream_subdomain=dns1 slipstream_ns_hostname=ns1"
#
# For multiple servers, use different subdomains:
#   Server 1: slipstream_subdomain=dns1 slipstream_ns_hostname=ns1
#   Server 2: slipstream_subdomain=dns2 slipstream_ns_hostname=ns2
#   Server 3: slipstream_subdomain=mail1 slipstream_ns_hostname=ns3

# slipstream_base_domain: ""      # REQUIRED - Base domain (must be in domain_providers)
# slipstream_subdomain: ""        # REQUIRED - Tunnel subdomain (dns1, mail1, etc.)
# slipstream_ns_hostname: ""      # REQUIRED - Nameserver hostname (ns1, ns2, etc.)

# Whether to automatically create DNS records (NS + A/AAAA for nameserver)
slipstream_create_dns_records: true

