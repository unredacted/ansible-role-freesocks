# tasks/dns.yml - DNS record management

# Set per-domain Cloudflare credentials (allows multi-account support)
- name: Set domain-specific Cloudflare credentials
  set_fact:
    cf_token: "{{ domain_providers[base_domain].cloudflare_api_token | default(cloudflare_api_token) }}"

- name: Install wamerican package for word list
  apt:
    name: wamerican
    state: present
  become: yes
  when: random_hostname is not defined and custom_hostname is not defined

- name: Get random words from system dictionary
  shell: 'grep "^[a-z]\{3,8\}$" /usr/share/dict/words | tr "[:upper:]" "[:lower:]" | shuf -n {{ hostname_word_count }}'
  register: random_words
  when: random_hostname is not defined and custom_hostname is not defined

- name: Set random hostname from dictionary words
  set_fact:
    random_hostname: "{{ random_words.stdout_lines | join('-') }}"
  when: 
    - random_hostname is not defined
    - custom_hostname is not defined

- name: Set random hostname from custom override
  set_fact:
    random_hostname: "{{ custom_hostname }}"
  when: 
    - random_hostname is not defined
    - custom_hostname is defined

- name: Set DNS hostname
  set_fact:
    dns_hostname: "{{ random_hostname }}.{{ base_domain }}"
  when: dns_hostname is not defined

- name: Set KV store hostname
  set_fact:
    kv_hostname: "{{ random_hostname }}"
  when: kv_hostname is not defined

- name: Debug DNS variables
  debug:
    msg: 
      - "Random Hostname: {{ random_hostname }}"
      - "DNS Hostname: {{ dns_hostname }}"
      - "KV Hostname: {{ kv_hostname }}"
      - "Inventory Hostname: {{ inventory_hostname }}"
      - "API Endpoint: {{ cloudflare_api_endpoint }}"
      - "Zone ID: {{ domain_providers[base_domain].zone_id }}"
      - "Envoy Mappings Available: {{ envoy_mappings[inventory_hostname] is defined }}"

# Base domain DNS records
- name: Add DNS A records for IPv4 addresses from envoy mappings
  uri:
    url: "{{ cloudflare_api_endpoint }}/zones/{{ domain_providers[base_domain].zone_id }}/dns_records"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ cf_token }}"
      
    body_format: json
    body:
      type: A
      name: "{{ random_hostname }}"
      content: "{{ item }}"
      ttl: 1
      proxied: "{{ dns_proxied | default(false) }}"
    status_code: [200, 201]
  delegate_to: localhost
  loop: "{{ envoy_mappings[inventory_hostname].ipv4 }}"
  when: 
    - envoy_mappings is defined
    - envoy_mappings[inventory_hostname] is defined
    - envoy_mappings[inventory_hostname].ipv4 is defined
  register: dns_a_records_result

- name: Debug DNS A records results
  debug:
    var: dns_a_records_result
  when: dns_a_records_result is defined

- name: Add DNS AAAA records for IPv6 addresses from envoy mappings
  uri:
    url: "{{ cloudflare_api_endpoint }}/zones/{{ domain_providers[base_domain].zone_id }}/dns_records"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ cf_token }}"
      
    body_format: json
    body:
      type: AAAA
      name: "{{ random_hostname }}"
      content: "{{ item }}"
      ttl: 1
      proxied: "{{ dns_proxied | default(false) }}"
    status_code: [200, 201]
  delegate_to: localhost
  loop: "{{ envoy_mappings[inventory_hostname].ipv6 }}"
  when: 
    - envoy_mappings is defined
    - envoy_mappings[inventory_hostname] is defined
    - envoy_mappings[inventory_hostname].ipv6 is defined
  register: dns_aaaa_records_result

- name: Debug DNS AAAA records results
  debug:
    var: dns_aaaa_records_result
  when: dns_aaaa_records_result is defined

# Only single-domain DNS setup is supported (base_domain)

# Fallback to server's own IPs if no envoy mappings are found
- name: Add DNS A record using server IP
  uri:
    url: "{{ cloudflare_api_endpoint }}/zones/{{ domain_providers[base_domain].zone_id }}/dns_records"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ cf_token }}"
      
    body_format: json
    body:
      type: A
      name: "{{ random_hostname }}"
      content: '{{ ansible_facts["default_ipv4"]["address"] }}'
      ttl: 1
      proxied: "{{ dns_proxied | default(false) }}"
    status_code: [200, 201]
  delegate_to: localhost
  when: 
    - envoy_mappings is not defined or envoy_mappings[inventory_hostname] is not defined or envoy_mappings[inventory_hostname].ipv4 is not defined
    - ansible_facts['default_ipv4']['address'] is defined
  register: fallback_dns_a_record_result

- name: Debug fallback DNS A record result
  debug:
    var: fallback_dns_a_record_result
  when: fallback_dns_a_record_result is defined

- name: Add DNS AAAA record using server IP
  uri:
    url: "{{ cloudflare_api_endpoint }}/zones/{{ domain_providers[base_domain].zone_id }}/dns_records"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ cf_token }}"
      
    body_format: json
    body:
      type: AAAA
      name: "{{ random_hostname }}"
      content: '{{ ansible_facts["default_ipv6"]["address"] }}'
      ttl: 1
      proxied: "{{ dns_proxied | default(false) }}"
    status_code: [200, 201]
  delegate_to: localhost
  when: 
    - envoy_mappings is not defined or envoy_mappings[inventory_hostname] is not defined or envoy_mappings[inventory_hostname].ipv6 is not defined
    - ansible_facts['default_ipv6']['address'] is defined
  register: fallback_dns_aaaa_record_result

- name: Debug fallback DNS AAAA record result
  debug:
    var: fallback_dns_aaaa_record_result
  when: fallback_dns_aaaa_record_result is defined


