# tasks/migrate/destination_tunnel_cleanup.yml - Clean up existing tunnel for destination hostname

# Set per-domain Cloudflare credentials (allows multi-account support)
- name: Set domain-specific Cloudflare credentials
  set_fact:
    cf_token: "{{ domain_providers[base_domain].cloudflare_api_token | default(cloudflare_api_token) }}"
    cf_account_id: "{{ domain_providers[base_domain].cloudflare_account_id | default(cloudflare_account_id) }}"

- name: Get existing tunnels
  uri:
    url: "{{ cloudflare_api_endpoint }}/accounts/{{ cf_account_id }}/cfd_tunnel"
    method: GET
    headers:
      Authorization: "Bearer {{ cf_token }}"
      
    status_code: 200
  delegate_to: localhost
  register: existing_tunnels
  when: 
    - inventory_hostname == destination_hostname
  run_once: true

- name: Find tunnel ID for destination hostname
  set_fact:
    destination_tunnel_id: "{{ item.id }}"
  loop: "{{ existing_tunnels.json.result }}"
  when: 
    - inventory_hostname == destination_hostname
    - item.name == destination_kv_hostname + (hostname_extension | default(''))
  run_once: true

- name: Get existing DNS records for tunnel cleanup
  uri:
    url: "{{ cloudflare_api_endpoint }}/zones/{{ cloudflare_zone_id }}/dns_records"
    method: GET
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ cf_token }}"
      
    status_code: 200
  delegate_to: localhost
  register: tunnel_dns_records
  when: 
    - inventory_hostname == destination_hostname
    - destination_tunnel_id is defined
  run_once: true

- name: Delete tunnel DNS CNAME records for API domain
  uri:
    url: "{{ cloudflare_api_endpoint }}/zones/{{ cloudflare_zone_id }}/dns_records/{{ item.id }}"
    method: DELETE
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ cf_token }}"
      
    status_code: 200
  delegate_to: localhost
  loop: "{{ tunnel_dns_records.json.result }}"
  when: 
    - inventory_hostname == destination_hostname
    - destination_tunnel_id is defined
    - item.type == 'CNAME'
    - (item.name == destination_kv_hostname + api_hostname_suffix + '.' + api_domain or item.name == destination_kv_hostname + prom_hostname_suffix + '.' + prom_domain)
  run_once: true



- name: Delete existing tunnel
  uri:
    url: "{{ cloudflare_api_endpoint }}/accounts/{{ cf_account_id }}/cfd_tunnel/{{ destination_tunnel_id }}"
    method: DELETE
    headers:
      Authorization: "Bearer {{ cf_token }}"
      
    status_code: 200
  delegate_to: localhost
  when: 
    - inventory_hostname == destination_hostname
    - destination_tunnel_id is defined
  run_once: true
