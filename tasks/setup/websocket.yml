---
# tasks/setup/websocket.yml - Configure WebSocket (WSS) support
# This configures the Outline server to use Shadowsocks over WebSocket (SS over WSS)
# for improved censorship resistance.

- name: Set effective Caddy domain
  set_fact:
    effective_caddy_domain: "{{ outline_caddy_domain | default(dns_hostname, true) }}"

- name: Install wamerican package for word list (WSS paths)
  apt:
    name: wamerican
    state: present
  become: yes
  when: outline_wss_random_paths | default(true)

- name: Generate random word count for TCP path
  set_fact:
    _wss_tcp_path_word_count: "{{ range(outline_wss_random_path_min_words, outline_wss_random_path_max_words + 1) | random }}"
  when: outline_wss_random_paths | default(true)

- name: Generate random word count for UDP path
  set_fact:
    _wss_udp_path_word_count: "{{ range(outline_wss_random_path_min_words, outline_wss_random_path_max_words + 1) | random }}"
  when: outline_wss_random_paths | default(true)

- name: Generate random words for TCP path
  shell: 'grep "^[a-z]\{3,8\}$" /usr/share/dict/words | shuf -n {{ _wss_tcp_path_word_count }}'
  register: _wss_tcp_path_words
  when: outline_wss_random_paths | default(true)

- name: Generate random words for UDP path
  shell: 'grep "^[a-z]\{3,8\}$" /usr/share/dict/words | shuf -n {{ _wss_udp_path_word_count }}'
  register: _wss_udp_path_words
  when: outline_wss_random_paths | default(true)

- name: Set random WebSocket paths from dictionary words
  set_fact:
    effective_wss_tcp_path: "/{{ _wss_tcp_path_words.stdout_lines | join('-') }}"
    effective_wss_udp_path: "/{{ _wss_udp_path_words.stdout_lines | join('-') }}"
  when: outline_wss_random_paths | default(true)

- name: Use configured WebSocket paths
  set_fact:
    effective_wss_tcp_path: "{{ outline_wss_tcp_path }}"
    effective_wss_udp_path: "{{ outline_wss_udp_path }}"
  when: not (outline_wss_random_paths | default(true))

- name: Wait for Outline API to be available
  uri:
    url: "{{ outline_api_info.apiUrl }}/server"
    method: GET
    validate_certs: no
  register: api_check
  retries: 10
  delay: 5
  until: api_check.status == 200

- name: Configure listeners for new access keys (WebSocket-only)
  uri:
    url: "{{ outline_api_info.apiUrl }}/server/listeners-for-new-access-keys"
    method: PUT
    body_format: json
    body:
      websocketStream:
        path: "{{ effective_wss_tcp_path }}"
        webServerPort: "{{ outline_wss_server_port }}"
      websocketPacket:
        path: "{{ effective_wss_udp_path }}"
        webServerPort: "{{ outline_wss_server_port }}"
    validate_certs: no
    status_code: 204
  register: listeners_result

- name: Debug listeners configuration
  debug:
    msg: "Listeners configured: TCP path={{ effective_wss_tcp_path }}, UDP path={{ effective_wss_udp_path }}{{ ' (randomized)' if outline_wss_random_paths else '' }}"

- name: Enable Caddy web server with auto HTTPS
  uri:
    url: "{{ outline_api_info.apiUrl }}/server/web-server"
    method: PUT
    body_format: json
    body:
      enabled: true
      autoHttps: "{{ outline_caddy_auto_https }}"
      email: "{{ outline_caddy_email }}"
      domain: "{{ effective_caddy_domain }}"
      apiProxyPath: "{{ outline_api_proxy_path | default(omit) }}"
    validate_certs: no
    status_code: 204
  register: caddy_result
  when: outline_caddy_auto_https

- name: Enable Caddy web server without auto HTTPS
  uri:
    url: "{{ outline_api_info.apiUrl }}/server/web-server"
    method: PUT
    body_format: json
    body:
      enabled: true
      autoHttps: false
      domain: "{{ effective_caddy_domain }}"
      apiProxyPath: "{{ outline_api_proxy_path | default(omit) }}"
    validate_certs: no
    status_code: 204
  register: caddy_result_no_https
  when: not outline_caddy_auto_https

- name: Display WSS configuration success
  debug:
    msg: |
      WebSocket (WSS) support configured successfully!
      
      Caddy Domain: {{ effective_caddy_domain }}
      Auto HTTPS: {{ outline_caddy_auto_https }}
      TCP Path: {{ effective_wss_tcp_path }}{{ ' (randomized)' if outline_wss_random_paths else '' }}
      UDP Path: {{ effective_wss_udp_path }}{{ ' (randomized)' if outline_wss_random_paths else '' }}
      Internal WS Port: {{ outline_wss_server_port }}
      
      New access keys will be WebSocket-only by default.
      Caddy is listening on port 443 for HTTPS/WSS traffic.
