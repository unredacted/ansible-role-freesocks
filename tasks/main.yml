# tasks/main.yml - Main task file that includes other task files

# ============================================================================
# VALIDATION: Vault Decryption Check
# ============================================================================
- name: Fail if vault-encrypted variables are not decrypted
  fail:
    msg: |
      Vault-encrypted variables detected but not decrypted!
      Please run the playbook with --ask-vault-pass or configure vault password file.
      Example: ansible-playbook playbook.yml --ask-vault-pass --extra-vars "..."
  when: >
    (cloudflare_api_token is defined and cloudflare_api_token is string and 
     '$ANSIBLE_VAULT;' in cloudflare_api_token)

# ============================================================================
# VALIDATION: Operation Mode
# ============================================================================
- name: Fail if operation mode is not specified
  fail:
    msg: "Operation mode must be explicitly set to 'deploy', 'migrate', or 'change'"
  when: operation_mode is not defined or operation_mode == ""

- name: Fail if operation mode is invalid
  fail:
    msg: "Operation mode must be 'deploy', 'migrate', or 'change', got: {{ operation_mode }}"
  when: operation_mode is defined and operation_mode not in ['deploy', 'migrate', 'change']

# ============================================================================
# VALIDATION: Environment Mode
# ============================================================================
- name: Fail if environment mode is not specified
  fail:
    msg: "Environment mode must be explicitly set to either 'prod' or 'dev' via --extra-vars"
  when: environment_mode is not defined or environment_mode == ""

- name: Fail if environment mode is invalid
  fail:
    msg: "Environment mode must be either 'prod' or 'dev', got: {{ environment_mode }}"
  when: environment_mode is defined and environment_mode not in ['prod', 'dev']

# ============================================================================
# VALIDATION: Provider Configuration
# ============================================================================
# Note: For change and deploy modes, dns_provider and tunnel_provider are derived from domain_providers
- name: Fail if dns_provider is not specified
  fail:
    msg: "dns_provider must be explicitly set (e.g., 'cloudflare')"
  when:
    - operation_mode not in ['change', 'deploy']
    - dns_provider is not defined or dns_provider == ""

- name: Fail if dns_provider is invalid
  fail:
    msg: "dns_provider must be 'cloudflare', got: {{ dns_provider }}"
  when:
    - operation_mode not in ['change', 'deploy']
    - dns_provider is defined
    - dns_provider not in ['cloudflare']

- name: Fail if tunnel_provider is not specified
  fail:
    msg: "tunnel_provider must be explicitly set (e.g., 'cloudflare' or 'none')"
  when:
    - operation_mode not in ['change', 'deploy']
    - tunnel_provider is not defined or tunnel_provider == ""

- name: Fail if tunnel_provider is invalid
  fail:
    msg: "tunnel_provider must be 'cloudflare' or 'none', got: {{ tunnel_provider }}"
  when:
    - operation_mode not in ['change', 'deploy']
    - tunnel_provider is defined
    - tunnel_provider not in ['cloudflare', 'none']

- name: Fail if kv_provider is not specified
  fail:
    msg: "kv_provider must be explicitly set (e.g., 'cloudflare')"
  when: kv_provider is not defined or kv_provider == ""

- name: Fail if kv_provider is invalid
  fail:
    msg: "kv_provider must be 'cloudflare', got: {{ kv_provider }}"
  when: kv_provider not in ['cloudflare']

# ============================================================================
# VALIDATION: Deploy Mode (New)
# ============================================================================
- name: Fail if deploy_target_domain is not provided (Deploy Mode)
  fail:
    msg: |
      deploy_target_domain is required for deploy mode.
      Please provide the target domain via --extra-vars.
      Example: --extra-vars "deploy_target_domain=example.app"
  when: 
    - operation_mode == 'deploy'
    - deploy_target_domain is not defined or deploy_target_domain == ''

- name: Fail if domain_providers is not configured (Deploy Mode)
  fail:
    msg: "domain_providers mapping is required for deploy mode."
  when: 
    - operation_mode == 'deploy'
    - (domain_providers is not defined or domain_providers | length == 0)

- name: Fail if target domain not found in domain_providers (Deploy Mode)
  fail:
    msg: |
      Domain '{{ deploy_target_domain }}' not found in domain_providers mapping.
      Available domains: {{ domain_providers.keys() | list | join(', ') }}
  when: 
    - operation_mode == 'deploy'
    - deploy_target_domain not in domain_providers

# ============================================================================
# SETUP: Deploy Mode Configuration
# ============================================================================
- name: Set provider configuration for deploy target domain
  set_fact:
    target_domain_config: "{{ domain_providers[deploy_target_domain] }}"
    effective_dns_provider: "{{ domain_providers[deploy_target_domain].dns_provider }}"
    effective_tunnel_provider: "{{ domain_providers[deploy_target_domain].tunnel_provider | default('none') }}"
    effective_zone_id: "{{ domain_providers[deploy_target_domain].zone_id }}"
    # Override global variables for this deployment
    base_domain: "{{ deploy_target_domain }}"
    api_domain: "{{ deploy_target_domain }}"
    prom_domain: "{{ deploy_target_domain }}"
    cloudflare_zone_id: "{{ domain_providers[deploy_target_domain].zone_id }}"
    base_domain_cloudflare_zone_id: "{{ domain_providers[deploy_target_domain].zone_id }}"
  when: operation_mode == 'deploy'

# ============================================================================
# KV NAMESPACE SETUP (provider-specific)
# ============================================================================
- name: Set effective KV namespaces based on environment mode (Cloudflare)
  set_fact:
    cloudflare_api_kv_namespace: "{{ cloudflare_api_kv_namespace_dev if environment_mode == 'dev' else cloudflare_api_kv_namespace_prod }}"
    cloudflare_prom_kv_namespace: "{{ cloudflare_prom_kv_namespace_dev if environment_mode == 'dev' else cloudflare_prom_kv_namespace_prod }}"
  when: kv_provider == 'cloudflare'

- name: Fail if Cloudflare KV namespaces are not configured
  fail:
    msg: "KV namespaces must be configured. Set cloudflare_api_kv_namespace_{{ environment_mode }} and cloudflare_prom_kv_namespace_{{ environment_mode }}"
  when: 
    - kv_provider == 'cloudflare'
    - cloudflare_api_kv_namespace is not defined or cloudflare_api_kv_namespace == "" or cloudflare_prom_kv_namespace is not defined or cloudflare_prom_kv_namespace == ""

# ============================================================================
# VALIDATION & SETUP: Change Mode
# ============================================================================
- name: Fail if change_target_domain is not provided (Change Mode)
  fail:
    msg: |
      change_target_domain is required for change mode.
      Please provide the target domain via --extra-vars.
      Example: --extra-vars "change_target_domain=example.app"
  when: 
    - operation_mode == 'change'
    - change_target_domain is not defined or change_target_domain == ''

- name: Fail if domain_providers is not configured (Change Mode)
  fail:
    msg: |
      domain_providers mapping is required for change mode.
      Please configure domain_providers in your playbook with provider settings for each domain.
  when: 
    - operation_mode == 'change'
    - (domain_providers is not defined or domain_providers | length == 0)

- name: Fail if target domain not found in domain_providers (Change Mode)
  fail:
    msg: |
      Domain '{{ change_target_domain }}' not found in domain_providers mapping.
      Available domains: {{ domain_providers.keys() | list | join(', ') }}
  when: 
    - operation_mode == 'change'
    - change_target_domain not in domain_providers

- name: Set provider configuration for change target domain
  set_fact:
    target_domain_config: "{{ domain_providers[change_target_domain] }}"
    effective_dns_provider: "{{ domain_providers[change_target_domain].dns_provider }}"
    effective_tunnel_provider: "{{ domain_providers[change_target_domain].tunnel_provider | default('none') }}"
    effective_zone_id: "{{ domain_providers[change_target_domain].zone_id }}"
  when: operation_mode == 'change'

- name: Debug configuration
  debug:
    msg:
      - "Operation Mode: {{ operation_mode }}"
      - "Environment Mode: {{ environment_mode }}"
      - "DNS Provider: {{ effective_dns_provider | default(dns_provider) }}"
      - "Tunnel Provider: {{ effective_tunnel_provider | default(tunnel_provider) }}"
      - "KV Provider: {{ kv_provider }}"
      - "API KV Namespace: {{ cloudflare_api_kv_namespace | default('N/A') }}"
      - "Prom KV Namespace: {{ cloudflare_prom_kv_namespace | default('N/A') }}"
      - "Deploy Target Domain: {{ deploy_target_domain | default('N/A') }}"

# ============================================================================
# DEPLOY MODE
# ============================================================================
- name: Deploy new Outline server
  block:
    - name: Check if /opt/outline already exists
      stat:
        path: /opt/outline
      register: outline_path

    - name: Fail if /opt/outline already exists
      fail:
        msg: "Cannot deploy: /opt/outline already exists. Please remove it first or use migration mode."
      when: outline_path.stat.exists

    - name: Install wamerican package for word list
      apt:
        name: wamerican
        state: present

    - name: Get random words from system dictionary
      shell: 'grep "^[a-z]\{3,8\}$" /usr/share/dict/words | tr "[:upper:]" "[:lower:]" | shuf -n 3'
      register: random_words

    - name: Set random hostname
      set_fact:
        random_hostname: "{{ random_words.stdout_lines | join('-') }}"
      when: random_hostname is not defined

    - name: Set DNS hostname
      set_fact:
        dns_hostname: "{{ random_hostname }}.{{ base_domain }}"
      when: dns_hostname is not defined

    - name: Set KV store hostname
      set_fact:
        kv_hostname: "{{ random_hostname }}"
      when: kv_hostname is not defined

    - name: Debug hostname variables
      debug:
        msg:
          - "Random Hostname: {{ random_hostname }}"
          - "DNS Hostname: {{ dns_hostname }}"
          - "KV Hostname: {{ kv_hostname }}"

    # Provider-specific installation
    - name: Include Cloudflare installation tasks
      include_tasks: providers/cloudflare/install.yml
      when: effective_tunnel_provider == 'cloudflare'

    - name: Include base installation tasks
      include_tasks: setup/install.yml

    - name: Include Outline server tasks
      include_tasks: setup/outline.yml

    - name: Debug Outline installation success
      debug:
        msg: "Outline installation success: {{ outline_install_success }}"

    # Provider-specific DNS setup
    - name: Include DNS tasks (Cloudflare)
      include_tasks: providers/cloudflare/dns.yml
      when: 
        - outline_install_success | bool
        - effective_dns_provider == 'cloudflare'

    # Provider-specific tunnel setup
    - name: Include tunnel tasks (Cloudflare)
      include_tasks: providers/cloudflare/tunnel.yml
      when: 
        - outline_install_success | bool
        - effective_tunnel_provider == 'cloudflare'

    # WebSocket configuration (must run AFTER DNS and tunnel are set up)
    # Caddy needs DNS to be configured for ACME certificate provisioning
    - name: Include WebSocket configuration tasks
      include_tasks: setup/websocket.yml
      when:
        - outline_install_success | bool
        - outline_wss_enabled | default(false) | bool

    # Provider-specific KV store setup
    - name: Include KV store tasks (Cloudflare)
      include_tasks: providers/cloudflare/kv.yml
      when: 
        - outline_install_success | bool
        - kv_provider == 'cloudflare'
  when: operation_mode == 'deploy'

# ============================================================================
# MIGRATE MODE
# ============================================================================
- name: Migrate existing Outline server
  block:
    - name: Verify required migration variables
      fail:
        msg: "Migration requires source_hostname, source_kv_hostname, destination_hostname, and destination_kv_hostname to be set"
      when: >
        source_hostname is not defined or 
        source_kv_hostname is not defined or 
        destination_hostname is not defined or 
        destination_kv_hostname is not defined

    - name: Check if /opt/outline already exists
      stat:
        path: /opt/outline
      register: outline_path
      when: inventory_hostname == destination_hostname

    - name: Fail if /opt/outline already exists
      fail:
        msg: "Cannot migrate: /opt/outline already exists on the destination server. Please remove it first."
      when: 
        - inventory_hostname == destination_hostname
        - outline_path.stat.exists | default(false)

    # Provider-specific installation
    - name: Include Cloudflare installation tasks
      include_tasks: providers/cloudflare/install.yml
      when: 
        - inventory_hostname == destination_hostname
        - tunnel_provider == 'cloudflare'

    - name: Include base installation tasks
      include_tasks: setup/install.yml
      when: inventory_hostname == destination_hostname

    - name: Include migration tasks
      include_tasks: migrate/migrate.yml
  when: operation_mode == 'migrate'

# ============================================================================
# CHANGE MODE
# ============================================================================
- name: Change hostname for blocked server
  block:
    - name: Check if /opt/outline exists
      stat:
        path: /opt/outline
      register: outline_path

    - name: Fail if /opt/outline does not exist
      fail:
        msg: "Cannot change hostname: /opt/outline does not exist. This server may not have Outline installed."
      when: not outline_path.stat.exists

    - name: Include change tasks
      include_tasks: change/change.yml
  when: operation_mode == 'change'
