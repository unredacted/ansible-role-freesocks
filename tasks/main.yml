# tasks/main.yml - Main task file that includes other task files

# ============================================================================
# VALIDATION: Vault Decryption Check
# ============================================================================
- name: Fail if vault-encrypted variables are not decrypted
  fail:
    msg: |
      Vault-encrypted variables detected but not decrypted!
      Please run the playbook with --ask-vault-pass or configure vault password file.
      Example: ansible-playbook playbook.yml --ask-vault-pass --extra-vars "..."
  when: >
    (cloudflare_api_token is defined and cloudflare_api_token is string and 
     '$ANSIBLE_VAULT;' in cloudflare_api_token)

# ============================================================================
# VALIDATION: Operation Mode
# ============================================================================
- name: Fail if operation mode is not specified
  fail:
    msg: "Operation mode must be explicitly set to 'deploy', 'migrate', or 'change'"
  when: operation_mode is not defined or operation_mode == ""

- name: Fail if operation mode is invalid
  fail:
    msg: "Operation mode must be 'deploy', 'migrate', or 'change', got: {{ operation_mode }}"
  when: operation_mode is defined and operation_mode not in ['deploy', 'migrate', 'change']

# ============================================================================
# VALIDATION: Environment Mode
# ============================================================================
- name: Fail if environment mode is not specified
  fail:
    msg: "Environment mode must be explicitly set to either 'prod' or 'dev' via --extra-vars"
  when: environment_mode is not defined or environment_mode == ""

- name: Fail if environment mode is invalid
  fail:
    msg: "Environment mode must be either 'prod' or 'dev', got: {{ environment_mode }}"
  when: environment_mode is defined and environment_mode not in ['prod', 'dev']

# ============================================================================
# VALIDATION: Provider Configuration
# ============================================================================
- name: Fail if dns_provider is not specified
  fail:
    msg: "dns_provider must be explicitly set (e.g., 'cloudflare')"
  when: dns_provider is not defined or dns_provider == ""

- name: Fail if dns_provider is invalid
  fail:
    msg: "dns_provider must be 'cloudflare', got: {{ dns_provider }}"
  when: dns_provider not in ['cloudflare']

- name: Fail if tunnel_provider is not specified
  fail:
    msg: "tunnel_provider must be explicitly set (e.g., 'cloudflare' or 'none')"
  when: tunnel_provider is not defined or tunnel_provider == ""

- name: Fail if tunnel_provider is invalid
  fail:
    msg: "tunnel_provider must be 'cloudflare' or 'none', got: {{ tunnel_provider }}"
  when: tunnel_provider not in ['cloudflare', 'none']

- name: Fail if kv_provider is not specified
  fail:
    msg: "kv_provider must be explicitly set (e.g., 'cloudflare')"
  when: kv_provider is not defined or kv_provider == ""

- name: Fail if kv_provider is invalid
  fail:
    msg: "kv_provider must be 'cloudflare', got: {{ kv_provider }}"
  when: kv_provider not in ['cloudflare']

# ============================================================================
# KV NAMESPACE SETUP (provider-specific)
# ============================================================================
- name: Set effective KV namespaces based on environment mode (Cloudflare)
  set_fact:
    cloudflare_api_kv_namespace: "{{ cloudflare_api_kv_namespace_dev if environment_mode == 'dev' else cloudflare_api_kv_namespace_prod }}"
    cloudflare_prom_kv_namespace: "{{ cloudflare_prom_kv_namespace_dev if environment_mode == 'dev' else cloudflare_prom_kv_namespace_prod }}"
  when: kv_provider == 'cloudflare'

- name: Fail if Cloudflare KV namespaces are not configured
  fail:
    msg: "KV namespaces must be configured. Set cloudflare_api_kv_namespace_{{ environment_mode }} and cloudflare_prom_kv_namespace_{{ environment_mode }}"
  when: 
    - kv_provider == 'cloudflare'
    - cloudflare_api_kv_namespace is not defined or cloudflare_api_kv_namespace == "" or cloudflare_prom_kv_namespace is not defined or cloudflare_prom_kv_namespace == ""

- name: Debug configuration
  debug:
    msg:
      - "Operation Mode: {{ operation_mode }}"
      - "Environment Mode: {{ environment_mode }}"
      - "DNS Provider: {{ dns_provider }}"
      - "Tunnel Provider: {{ tunnel_provider }}"
      - "KV Provider: {{ kv_provider }}"
      - "API KV Namespace: {{ cloudflare_api_kv_namespace | default('N/A') }}"
      - "Prom KV Namespace: {{ cloudflare_prom_kv_namespace | default('N/A') }}"

# ============================================================================
# DEPLOY MODE
# ============================================================================
- name: Deploy new Outline server
  block:
    - name: Check if /opt/outline already exists
      stat:
        path: /opt/outline
      register: outline_path

    - name: Fail if /opt/outline already exists
      fail:
        msg: "Cannot deploy: /opt/outline already exists. Please remove it first or use migration mode."
      when: outline_path.stat.exists

    - name: Install wamerican package for word list
      apt:
        name: wamerican
        state: present

    - name: Get random words from system dictionary
      shell: 'grep "^[a-z]\{3,8\}$" /usr/share/dict/words | tr "[:upper:]" "[:lower:]" | shuf -n 3'
      register: random_words

    - name: Set random hostname
      set_fact:
        random_hostname: "{{ random_words.stdout_lines | join('-') }}"
      when: random_hostname is not defined

    - name: Set DNS hostname
      set_fact:
        dns_hostname: "{{ random_hostname }}.{{ base_domain }}"
      when: dns_hostname is not defined

    - name: Set KV store hostname
      set_fact:
        kv_hostname: "{{ random_hostname }}"
      when: kv_hostname is not defined

    - name: Debug hostname variables
      debug:
        msg:
          - "Random Hostname: {{ random_hostname }}"
          - "DNS Hostname: {{ dns_hostname }}"
          - "KV Hostname: {{ kv_hostname }}"

    # Provider-specific installation
    - name: Include Cloudflare installation tasks
      include_tasks: providers/cloudflare/install.yml
      when: tunnel_provider == 'cloudflare'

    - name: Include base installation tasks
      include_tasks: setup/install.yml

    - name: Include Outline server tasks
      include_tasks: setup/outline.yml

    - name: Debug Outline installation success
      debug:
        msg: "Outline installation success: {{ outline_install_success }}"

    # Provider-specific DNS setup
    - name: Include DNS tasks (Cloudflare)
      include_tasks: providers/cloudflare/dns.yml
      when: 
        - outline_install_success | bool
        - dns_provider == 'cloudflare'

    # Provider-specific tunnel setup
    - name: Include tunnel tasks (Cloudflare)
      include_tasks: providers/cloudflare/tunnel.yml
      when: 
        - outline_install_success | bool
        - tunnel_provider == 'cloudflare'

    # WebSocket configuration (must run AFTER DNS and tunnel are set up)
    # Caddy needs DNS to be configured for ACME certificate provisioning
    - name: Include WebSocket configuration tasks
      include_tasks: setup/websocket.yml
      when:
        - outline_install_success | bool
        - outline_wss_enabled | default(false) | bool

    # Provider-specific KV store setup
    - name: Include KV store tasks (Cloudflare)
      include_tasks: providers/cloudflare/kv.yml
      when: 
        - outline_install_success | bool
        - kv_provider == 'cloudflare'
  when: operation_mode == 'deploy'

# ============================================================================
# MIGRATE MODE
# ============================================================================
- name: Migrate existing Outline server
  block:
    - name: Verify required migration variables
      fail:
        msg: "Migration requires source_hostname, source_kv_hostname, destination_hostname, and destination_kv_hostname to be set"
      when: >
        source_hostname is not defined or 
        source_kv_hostname is not defined or 
        destination_hostname is not defined or 
        destination_kv_hostname is not defined

    - name: Check if /opt/outline already exists
      stat:
        path: /opt/outline
      register: outline_path
      when: inventory_hostname == destination_hostname

    - name: Fail if /opt/outline already exists
      fail:
        msg: "Cannot migrate: /opt/outline already exists on the destination server. Please remove it first."
      when: 
        - inventory_hostname == destination_hostname
        - outline_path.stat.exists | default(false)

    # Provider-specific installation
    - name: Include Cloudflare installation tasks
      include_tasks: providers/cloudflare/install.yml
      when: 
        - inventory_hostname == destination_hostname
        - tunnel_provider == 'cloudflare'

    - name: Include base installation tasks
      include_tasks: setup/install.yml
      when: inventory_hostname == destination_hostname

    - name: Include migration tasks
      include_tasks: migrate/migrate.yml
  when: operation_mode == 'migrate'

# ============================================================================
# CHANGE MODE
# ============================================================================
- name: Change hostname for blocked server
  block:
    - name: Check if /opt/outline exists
      stat:
        path: /opt/outline
      register: outline_path

    - name: Fail if /opt/outline does not exist
      fail:
        msg: "Cannot change hostname: /opt/outline does not exist. This server may not have Outline installed."
      when: not outline_path.stat.exists

    - name: Include change tasks
      include_tasks: change/change.yml
  when: operation_mode == 'change'
