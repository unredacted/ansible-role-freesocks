# tasks/migrate/migrate.yml - Migration tasks orchestration

# Verify source server and stop containers (provider-specific)
- name: Include source verification tasks (Cloudflare)
  include_tasks: ../providers/cloudflare/migrate/verify_source.yml
  when: kv_provider == 'cloudflare'

# Setup destination server
- name: Set variables for Outline installation
  set_fact:
    random_hostname: "{{ destination_kv_hostname }}"
    dns_hostname: "{{ destination_kv_hostname }}.{{ base_domain }}"
    kv_hostname: "{{ destination_kv_hostname }}"
  when: inventory_hostname == destination_hostname

- name: Debug hostname variables
  debug:
    msg:
      - "Random Hostname: {{ random_hostname }}"
      - "DNS Hostname: {{ dns_hostname }}"
      - "KV Hostname: {{ kv_hostname }}"
  when: inventory_hostname == destination_hostname

- name: Install Outline on new server
  include_tasks: ../setup/outline.yml
  when: inventory_hostname == destination_hostname

- name: Stop Outline containers on new server
  docker_container:
    name: "{{ item }}"
    state: stopped
  loop:
    - watchtower
    - shadowbox
  become: yes
  when: 
    - inventory_hostname == destination_hostname
    - outline_install_success | default(false) | bool

# Transfer configuration and update files (provider-agnostic)
- name: Include configuration transfer tasks
  include_tasks: transfer_config.yml

# Clean up existing tunnel if needed (provider-specific)
- name: Include tunnel cleanup tasks (Cloudflare)
  include_tasks: ../providers/cloudflare/migrate/tunnel_cleanup.yml
  when: tunnel_provider == 'cloudflare'

# Manage containers (provider-agnostic)
- name: Include container management tasks
  include_tasks: containers.yml

# Clean up any existing tunnel for destination hostname (provider-specific)
- name: Include destination tunnel cleanup tasks (Cloudflare)
  include_tasks: ../providers/cloudflare/migrate/destination_tunnel_cleanup.yml
  when:
    - inventory_hostname == destination_hostname
    - outline_install_success | default(false) | bool
    - tunnel_provider == 'cloudflare'

# Setup tunnel (provider-specific)
- name: Include tunnel tasks (Cloudflare)
  include_tasks: ../providers/cloudflare/tunnel.yml
  when: 
    - inventory_hostname == destination_hostname
    - outline_install_success | default(false) | bool
    - tunnel_provider == 'cloudflare'

# Setup DNS records (provider-specific)
- name: Include DNS record management tasks (Cloudflare)
  include_tasks: ../providers/cloudflare/migrate/dns_records.yml
  when: dns_provider == 'cloudflare'

# Update KV store entries (provider-specific)
- name: Include KV store management tasks (Cloudflare)
  include_tasks: ../providers/cloudflare/migrate/kv_store.yml
  when: kv_provider == 'cloudflare'
