# Example playbook for ansible-role-freesocks
# See README.md for complete documentation and variable descriptions

- name: Deploy new Outline server
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: deploy
    kv_hostname_prefix: "outline1-ams"

    # Provider configuration
    dns_provider: cloudflare
    tunnel_provider: cloudflare
    kv_provider: cloudflare

    # Cloudflare configuration
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"
    cloudflare_email: "your-email@example.com"
    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_zone_id: "your-zone-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    # Domain configuration
    base_domain: "example.com"
    api_domain: "api.example.com"
    prom_domain: "prom.example.com"

    # Optional: Additional domains
    additional_domains:
      - domain: "example.app"
        zone_id: "app-zone-id"

    # Server configuration
    envoy_mappings:
      outline1-ams:
        ipv4: ["1.2.3.4", "5.6.7.8"]
        ipv6: ["2001:db8::1", "2001:db8::2"]

  roles:
    - ansible-role-freesocks

- name: Deploy new Outline server (without tunnel)
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: deploy
    kv_hostname_prefix: "outline2-ams"

    # Provider configuration - no tunnel, direct port access
    dns_provider: cloudflare
    tunnel_provider: none
    kv_provider: cloudflare

    # Same Cloudflare configuration as above...
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"
    cloudflare_email: "your-email@example.com"
    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_zone_id: "your-zone-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    base_domain: "example.com"
    api_domain: "api.example.com"
    prom_domain: "prom.example.com"

    envoy_mappings:
      outline2-ams:
        ipv4: ["1.2.3.4", "5.6.7.8"]
        ipv6: ["2001:db8::1", "2001:db8::2"]

  roles:
    - ansible-role-freesocks

- name: Deploy Outline server with WSS support
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: deploy
    kv_hostname_prefix: "outline3-ams"

    # WSS Configuration - enables Shadowsocks over WebSocket
    outline_wss_enabled: true
    outline_keys_port: 853  # Use non-443 port for SS to allow Caddy on 443
    outline_caddy_auto_https: true
    outline_caddy_email: "admin@example.com"
    # outline_caddy_domain: ""  # Defaults to dns_hostname

    # Provider configuration
    dns_provider: cloudflare
    tunnel_provider: cloudflare
    kv_provider: cloudflare

    # Same Cloudflare configuration as above...
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"
    cloudflare_email: "your-email@example.com"
    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_zone_id: "your-zone-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    base_domain: "example.com"
    api_domain: "api.example.com"
    prom_domain: "prom.example.com"

    envoy_mappings:
      outline3-ams:
        ipv4: ["1.2.3.4", "5.6.7.8"]
        ipv6: ["2001:db8::1", "2001:db8::2"]

  roles:
    - ansible-role-freesocks

- name: Migrate Outline server
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: migrate
    source_hostname: "outline1-ams"
    destination_hostname: "outline2-fra"
    migrate_delete_source: false

    # Provider configuration
    dns_provider: cloudflare
    tunnel_provider: cloudflare
    kv_provider: cloudflare

    # Include same Cloudflare and domain configuration as above
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"
    cloudflare_email: "your-email@example.com"
    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_zone_id: "your-zone-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    base_domain: "example.com"
    api_domain: "api.example.com"
    prom_domain: "prom.example.com"

    envoy_mappings:
      outline2-fra:
        ipv4: ["9.10.11.12", "13.14.15.16"]
        ipv6: ["2001:db8::3", "2001:db8::4"]

  roles:
    - ansible-role-freesocks

# Example inventory (hosts):
# [new_servers]
# outline2-fra ansible_host=10.0.0.2

# Usage (all provider variables are required):
# Deploy (Cloudflare, production):
#   ansible-playbook -i hosts example-playbook.yml \
#     --extra-vars "operation_mode=deploy environment_mode=prod dns_provider=cloudflare tunnel_provider=cloudflare kv_provider=cloudflare"
#
# Deploy (Cloudflare, no tunnel, dev mode):
#   ansible-playbook -i hosts example-playbook.yml \
#     --extra-vars "operation_mode=deploy environment_mode=dev dns_provider=cloudflare tunnel_provider=none kv_provider=cloudflare"
#
# Migrate (Cloudflare, production):
#   ansible-playbook -i hosts example-playbook.yml \
#     --extra-vars "operation_mode=migrate environment_mode=prod dns_provider=cloudflare tunnel_provider=cloudflare kv_provider=cloudflare source_hostname=outline1-ams destination_hostname=outline2-fra"
