# Example playbook for ansible-role-freesocks
# See README.md for complete documentation and variable descriptions

- name: Deploy new Outline server
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: deploy
    deploy_target_domain: "example.com"  # Deploy to this domain
    kv_hostname_prefix: "outline1-ams"

    # Domain-to-Provider Mapping
    domain_providers:
      example.com:
        dns_provider: cloudflare
        tunnel_provider: cloudflare
        zone_id: "your-zone-id-for-com"
      example.app:
        dns_provider: cloudflare
        tunnel_provider: none
        zone_id: "your-zone-id-for-app"

    # KV provider (global)
    kv_provider: cloudflare

    # Cloudflare configuration
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"

    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    # Server configuration
    envoy_mappings:
      outline1-ams:
        ipv4: ["1.2.3.4", "5.6.7.8"]
        ipv6: ["2001:db8::1", "2001:db8::2"]

  roles:
    - ansible-role-freesocks

- name: Deploy new Outline server (without tunnel)
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: deploy
    deploy_target_domain: "example.app"  # Deploy to different domain
    kv_hostname_prefix: "outline2-ams"

    # Domain-to-Provider Mapping (tunnel_provider: none for this domain)
    domain_providers:
      example.com:
        dns_provider: cloudflare
        tunnel_provider: cloudflare
        zone_id: "your-zone-id-for-com"
      example.app:
        dns_provider: cloudflare
        tunnel_provider: none  # Direct port access
        zone_id: "your-zone-id-for-app"

    # KV provider (global)
    kv_provider: cloudflare

    # Same Cloudflare configuration as above...
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"

    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    envoy_mappings:
      outline2-ams:
        ipv4: ["1.2.3.4", "5.6.7.8"]
        ipv6: ["2001:db8::1", "2001:db8::2"]

  roles:
    - ansible-role-freesocks

- name: Deploy Outline server with WSS support
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: deploy
    deploy_target_domain: "example.com"
    kv_hostname_prefix: "outline3-ams"

    # WSS Configuration - enables Shadowsocks over WebSocket
    outline_wss_enabled: true
    outline_keys_port: 853  # Use non-443 port for SS to allow Caddy on 443
    outline_caddy_auto_https: true
    outline_caddy_email: "admin@example.com"
    # outline_caddy_domain: ""  # Defaults to dns_hostname

    # WSS Path Configuration (random dictionary word paths are default)
    # outline_wss_random_paths: true              # Default: true
    # outline_wss_random_path_min_words: 3        # Default: 3 (e.g., /apple-banana-cherry)
    # outline_wss_random_path_max_words: 5        # Default: 5 (random word count in range)
    # Or use custom static paths:
    # outline_wss_random_paths: false
    # outline_wss_tcp_path: "/stream"
    # outline_wss_udp_path: "/packet"

    # Domain-to-Provider Mapping
    domain_providers:
      example.com:
        dns_provider: cloudflare
        tunnel_provider: cloudflare
        zone_id: "your-zone-id-for-com"

    # KV provider (global)
    kv_provider: cloudflare

    # Same Cloudflare configuration as above...
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"

    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    envoy_mappings:
      outline3-ams:
        ipv4: ["1.2.3.4", "5.6.7.8"]
        ipv6: ["2001:db8::1", "2001:db8::2"]

  roles:
    - ansible-role-freesocks

- name: Migrate Outline server
  hosts: new_servers
  remote_user: root
  vars:
    operation_mode: migrate
    source_hostname: "outline1-ams"
    source_kv_hostname: "apple-banana-cherry"  # KV key from old deployment
    destination_hostname: "outline2-fra"
    destination_kv_hostname: "dog-elephant-fox"  # New KV key for destination
    migrate_delete_source: false

    # Domain-to-Provider Mapping (base_domain used for migration)
    domain_providers:
      example.com:
        dns_provider: cloudflare
        tunnel_provider: cloudflare
        zone_id: "your-zone-id-for-com"

    # Active domain for migration
    base_domain: "example.com"
    api_domain: "example.com"
    prom_domain: "example.com"

    # KV provider (global)
    kv_provider: cloudflare

    # Include same Cloudflare configuration as above
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"

    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"
    cloudflare_access_team_name: "your-team-name"
    cloudflare_access_aud_tag: "your-aud-tag"

    envoy_mappings:
      outline2-fra:
        ipv4: ["9.10.11.12", "13.14.15.16"]
        ipv6: ["2001:db8::3", "2001:db8::4"]

  roles:
    - ansible-role-freesocks

- name: Change hostname (rotate to new domain)
  hosts: existing_servers
  remote_user: root
  vars:
    operation_mode: change
    # Target domain for the new hostname (generates random hostname like apple-banana-cherry.example.app)
    change_target_domain: "example.app"

    # Provider configuration (global - also needed for KV operations)
    kv_provider: cloudflare

    # Domain-to-Provider Mapping (for change mode)
    # Maps each domain to its DNS and tunnel provider configuration
    domain_providers:
      example.com:
        dns_provider: cloudflare
        tunnel_provider: cloudflare
        zone_id: "your-zone-id-for-com"
      example.app:
        dns_provider: cloudflare
        tunnel_provider: cloudflare
        zone_id: "your-zone-id-for-app"
      # Future: other providers
      # example.org:
      #   dns_provider: fastly
      #   tunnel_provider: none

    # Include same Cloudflare configuration as above
    cloudflare_api_endpoint: "https://api.cloudflare.com/client/v4"

    cloudflare_api_token: "your-api-token"
    cloudflare_account_id: "your-account-id"
    cloudflare_api_kv_namespace_prod: "your-prod-api-kv-namespace"
    cloudflare_prom_kv_namespace_prod: "your-prod-prom-kv-namespace"
    cloudflare_api_kv_namespace_dev: "your-dev-api-kv-namespace"
    cloudflare_prom_kv_namespace_dev: "your-dev-prom-kv-namespace"

    # Caddy configuration (for WSS servers)
    outline_caddy_email: "admin@example.com"

  roles:
    - ansible-role-freesocks

# Example inventory (hosts):
# [new_servers]
# outline2-fra ansible_host=10.0.0.2
# [existing_servers]
# outline1-ams ansible_host=10.0.0.1

# Usage:
# Deploy to example.com (production):
#   ansible-playbook -i hosts example-playbook.yml \
#     --extra-vars "environment_mode=prod deploy_target_domain=example.com"
#
# Deploy to example.app without tunnel (dev mode):
#   ansible-playbook -i hosts example-playbook.yml \
#     --extra-vars "environment_mode=dev deploy_target_domain=example.app"
#
# Migrate (production):
#   ansible-playbook -i hosts example-playbook.yml \
#     --extra-vars "environment_mode=prod source_hostname=outline1-ams source_kv_hostname=apple-banana-cherry destination_hostname=outline2-fra destination_kv_hostname=dog-elephant-fox"
# Change hostname (rotate to new domain when blocked):
#   ansible-playbook -i hosts example-playbook.yml \
#     --extra-vars "environment_mode=prod change_target_domain=example.app"
